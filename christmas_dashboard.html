<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No√´l √† Menetou üéÖ</title>
    <style>
        :root {
            --christmas-red: #d42426;
            --christmas-green: #2f5233;
            --gold: #f1c40f;
            --snow: #f0f0f0;
            --text-dark: #333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--snow);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--christmas-red), #b31b1d);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        header p {
            margin-top: 0.5rem;
            opacity: 0.9;
        }

        /* Snow effect decoration */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial;
            text-shadow: 0 0 1px #000;
            position: absolute;
            top: -10%;
            z-index: 9999;
            user-select: none;
            cursor: default;
            animation-name: snowflakes-fall, snowflakes-shake;
            animation-duration: 10s, 3s;
            animation-timing-function: linear, ease-in-out;
            animation-iteration-count: infinite, infinite;
            animation-play-state: running, running;
        }

        @keyframes snowflakes-fall {
            0% {
                top: -10%;
            }

            100% {
                top: 100%;
            }
        }

        @keyframes snowflakes-shake {
            0% {
                transform: translateX(0px);
            }

            50% {
                transform: translateX(80px);
            }

            100% {
                transform: translateX(0px);
            }
        }

        nav {
            background-color: var(--christmas-green);
            padding: 0.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-container {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 4px;
            font-weight: 500;
        }

        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .nav-btn.active {
            background-color: var(--gold);
            color: var(--christmas-green);
            font-weight: bold;
        }

        main {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
            min-height: 60vh;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--gold);
        }

        h2 {
            color: var(--christmas-green);
            border-bottom: 2px solid var(--gold);
            padding-bottom: 0.5rem;
            margin-top: 0;
        }

        /* Countdown */
        #countdown {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            font-weight: bold;
            color: var(--christmas-red);
        }

        .time-unit {
            text-align: center;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            min-width: 80px;
        }

        .time-unit span {
            display: block;
            font-size: 2rem;
        }

        .time-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #666;
        }

        /* Forms & Inputs */
        input,
        select,
        textarea {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button.action-btn {
            background-color: var(--christmas-red);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        button.action-btn:hover {
            background-color: #b31b1d;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            background-color: var(--text-dark);
            color: white;
            margin-top: 3rem;
        }

        /* Data Controls */
        .data-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .icon-btn {
            background: var(--text-dark);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .nav-container {
                gap: 0.5rem;
            }

            .nav-btn {
                padding: 0.5rem;
                font-size: 0.9rem;
                flex: 1 1 45%;
                text-align: center;
            }

            /* Generic Input Row Stacking */
            .input-row {
                flex-direction: column !important;
                align-items: stretch !important;
            }

            .input-row input,
            .input-row select,
            .input-row button {
                width: 100% !important;
                margin-bottom: 0.5rem !important;
                flex: none !important;
                margin-right: 0 !important;
            }

            /* Specific adjustments for buttons in rows */
            .input-row button {
                margin-top: 0.5rem;
            }

            /* Budget table scroll */
            #budget table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .card {
                padding: 1rem;
            }

            /* Task list items */
            #tasks-list-container li {
                flex-wrap: wrap;
            }

            #tasks-list-container li>input {
                margin-bottom: 0.5rem;
            }

            #tasks-list-container li>div {
                min-width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>

<body>

    <header>
        <h1>No√´l √† Menetou üéÖ</h1>
        <p>Organisation du Week-end Famille | 19 - 21 D√©cembre</p>
        <div class="snowflake" style="left: 10%; animation-delay: 0s;">‚ùÑ</div>
        <div class="snowflake" style="left: 30%; animation-delay: 2s;">‚ùÖ</div>
        <div class="snowflake" style="left: 70%; animation-delay: 4s;">‚ùÜ</div>
        <div class="snowflake" style="left: 90%; animation-delay: 1s;">‚ùÑ</div>
    </header>

    <nav>
        <div class="nav-container">
            <button class="nav-btn active" onclick="switchTab('home')">üè† Accueil</button>
            <button class="nav-btn" onclick="switchTab('menus')">üçΩÔ∏è Menus</button>
            <button class="nav-btn" onclick="switchTab('courses')">üõí Courses</button>
            <button class="nav-btn" onclick="switchTab('budget')">üí∞ Budget</button>
            <button class="nav-btn" onclick="switchTab('tasks')">‚úÖ T√¢ches</button>
        </div>
    </nav>

    <main>
        <!-- ACCUEIL -->
        <div id="home" class="tab-content active">
            <div class="card">
                <h2>Bienvenue !</h2>
                <p>Bienvenue sur le tableau de bord de notre No√´l en famille √† Menetou-sur-Cher.</p>
                <p>Utilisez les onglets ci-dessus pour naviguer et ajouter vos id√©es.</p>

                <div id="countdown">
                    <div class="time-unit"><span id="days">00</span>
                        <div class="time-label">Jours</div>
                    </div>
                    <div class="time-unit"><span id="hours">00</span>
                        <div class="time-label">Heures</div>
                    </div>
                    <div class="time-unit"><span id="minutes">00</span>
                        <div class="time-label">Minutes</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìç Informations Pratiques</h2>
                <ul>
                    <li><strong>Lieu :</strong> Menetou-sur-Cher (18)</li>
                    <li><strong>Arriv√©e :</strong> Vendredi 19 D√©cembre (Soir)</li>
                    <li><strong>D√©part :</strong> Dimanche 21 D√©cembre (Midi)</li>
                    <li><strong>Participants :</strong> 6 Adultes, 3 Enfants</li>
                </ul>
            </div>
        </div>

        <!-- MENUS -->
        <div id="menus" class="tab-content">
            <div class="card">
                <h2>üçΩÔ∏è Planification des Repas</h2>
                <div id="meals-container">
                    <!-- Les repas seront g√©n√©r√©s ici par JS -->
                </div>
            </div>
        </div>

        <!-- COURSES -->
        <div id="courses" class="tab-content">
            <div class="card">
                <h2>üõí Liste de Courses</h2>

                <div class="input-row" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="text" id="new-item-name" placeholder="Ajouter un article..."
                        style="flex: 2; margin-bottom: 0;">
                    <select id="new-item-category" style="flex: 1; margin-bottom: 0;">
                        <option value="Frais">Frais ü•¶</option>
                        <option value="√âpicerie">√âpicerie üçù</option>
                        <option value="Boissons">Boissons üç∑</option>
                        <option value="Autre">Autre üéà</option>
                    </select>
                    <button class="action-btn" onclick="addGroceryItem()">+</button>
                </div>

                <div id="grocery-list-container">
                    <!-- Liste g√©n√©r√©e par JS -->
                </div>
            </div>
        </div>

        <!-- BUDGET -->
        <div id="budget" class="tab-content">
            <div class="card">
                <h2>üí∞ Suivi du Budget</h2>

                <div
                    style="background: #e8f5e9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
                    <div style="font-size: 0.9rem; color: #666;">Co√ªt Total</div>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--christmas-green);" id="total-cost">0.00
                        ‚Ç¨</div>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">Soit par Adulte
                        (6)</div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-dark);" id="cost-per-adult">0.00
                        ‚Ç¨</div>
                </div>

                <div class="input-row" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="text" id="expense-desc" placeholder="Quoi ? (ex: Courses Leclerc)"
                        style="flex: 2; margin-bottom: 0;">
                    <input type="number" id="expense-amount" placeholder="Prix (‚Ç¨)" step="0.01"
                        style="flex: 1; margin-bottom: 0;">
                    <select id="expense-payer" style="flex: 1; margin-bottom: 0;">
                        <option value="">Qui a pay√© ?</option>
                        <!-- Rempli par JS -->
                    </select>
                    <button class="action-btn" onclick="addExpense()">+</button>
                </div>

                <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                    <thead>
                        <tr style="background: #f1f1f1; text-align: left;">
                            <th style="padding: 0.5rem;">Quoi</th>
                            <th style="padding: 0.5rem;">Qui</th>
                            <th style="padding: 0.5rem; text-align: right;">Montant</th>
                            <th style="padding: 0.5rem;"></th>
                        </tr>
                    </thead>
                    <tbody id="budget-list-container">
                        <!-- Liste g√©n√©r√©e par JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- TACHES -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <h2>‚úÖ R√©partition des T√¢ches</h2>

                <div class="input-row" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="text" id="task-desc" placeholder="T√¢che √† faire..." style="flex: 2; margin-bottom: 0;">
                    <select id="task-assignee" style="flex: 1; margin-bottom: 0;">
                        <option value="">Qui s'en occupe ?</option>
                        <!-- Rempli par JS -->
                    </select>
                    <button class="action-btn" onclick="addTask()">+</button>
                </div>

                <ul id="tasks-list-container" style="list-style: none; padding: 0;">
                    <!-- Liste g√©n√©r√©e par JS -->
                    <button class="icon-btn" onclick="openSettings()" title="Configuration">‚öôÔ∏è</button>
            </div>
            <div id="sync-status"
                style="position:fixed; bottom:80px; right:20px; font-size:0.8rem; color:var(--text-dark); background:rgba(255,255,255,0.9); padding:5px; border-radius:4px; pointer-events:none;">
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
                <div style="background:white; padding:2rem; border-radius:8px; width:90%; max-width:500px;">
                    <h3 style="margin-top:0; color:var(--christmas-green);">‚öôÔ∏è Configuration</h3>

                    <label style="display:block; margin-bottom:0.5rem; font-weight:bold;">URL de l'Application Web
                        (Google Apps
                        Script)</label>
                    <input type="text" id="api-url-input" placeholder="https://script.google.com/..."
                        style="width:100%; margin-bottom:1rem;">

                    <label style="display:block; margin-bottom:0.5rem; font-weight:bold;">Cl√© API Google Gemini
                        (IA)</label>
                    <input type="password" id="gemini-key-input" placeholder="AIzaSy..."
                        style="width:100%; margin-bottom:1rem;">
                    <div style="font-size:0.8rem; color:#666; margin-bottom:1rem;">La cl√© est stock√©e localement dans
                        votre
                        navigateur.</div>

                    <div style="display:flex; justify-content:flex-end; gap:1rem;">
                        <button onclick="closeSettings()"
                            style="background:#ccc; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer;">Annuler</button>
                        <button onclick="saveSettings()" class="action-btn">Enregistrer</button>
                    </div>
                </div>
            </div>

            <script>
                window.onerror = function (msg, url, line, col, error) {
                    alert("Erreur JS : " + msg + "\nLigne : " + line);
                    const errDiv = document.createElement('div');
                    errDiv.style.cssText = 'position:fixed; top:0; left:0; width:100%; background:red; color:white; padding:10px; z-index:9999;';
                    errDiv.innerText = "Erreur : " + msg + " (Ligne " + line + ")";
                    document.body.appendChild(errDiv);
                    return false;
                };

                // --- NAVIGATION ---
                function switchTab(tabId) {
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    const buttons = Array.from(document.querySelectorAll('.nav-btn'));
                    const activeButton = buttons.find(btn => btn.getAttribute('onclick').includes(tabId));
                    if (activeButton) activeButton.classList.add('active');
                }

                // --- COUNTDOWN ---
                function updateCountdown() {
                    const targetDate = new Date('December 19, 2025 18:00:00').getTime();
                    const now = new Date().getTime();
                    const distance = targetDate - now;

                    if (distance < 0) {
                        document.getElementById("countdown").innerHTML = "C'est parti ! üéÖ";
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

                    document.getElementById("days").innerText = days;
                    document.getElementById("hours").innerText = hours;
                    document.getElementById("minutes").innerText = minutes;
                }

                setInterval(updateCountdown, 60000);
                updateCountdown();

                // --- DATA MANAGEMENT (GOOGLE SHEETS & AI) ---
                const APP_DATA_KEY = 'noel_menetou_data';
                const API_URL_KEY = 'noel_menetou_api_url';
                const GEMINI_API_KEY_KEY = 'noel_menetou_gemini_key';

                let apiUrl = localStorage.getItem(API_URL_KEY) || '';
                let geminiKey = localStorage.getItem(GEMINI_API_KEY_KEY) || '';

                const PARTICIPANTS = ["Papy Dudu", "Mamie Sophie", "Marine", "Anthony", "Ang√©lique", "Paul", "Brune (Enfant)", "Alba (Enfant)", "Lilou (Enfant)"];

                const defaultData = {
                    meals: [
                        { id: 1, title: "Vendredi Soir (Arriv√©e)", starter: "", starter_by: "", main: "", main_by: "", dessert: "", dessert_by: "" },
                        { id: 2, title: "Samedi Midi", starter: "", starter_by: "", main: "", main_by: "", dessert: "", dessert_by: "" },
                        { id: 3, title: "Samedi Soir (R√©veillon)", starter: "", starter_by: "", main: "", main_by: "", dessert: "", dessert_by: "" },
                        { id: 4, title: "Dimanche Midi (D√©part)", starter: "", starter_by: "", main: "", main_by: "", dessert: "", dessert_by: "" }
                    ],
                    courses: [],
                    budget: [],
                    tasks: []
                };

                let appData = JSON.parse(JSON.stringify(defaultData));

                // Helper to generate participant options
                function getParticipantOptions(selectedValue) {
                    let options = '<option value="">-- Qui ? --</option>';
                    PARTICIPANTS.forEach(p => {
                        const selected = p === selectedValue ? 'selected' : '';
                        options += `<option value="${p}" ${selected}>${p}</option>`;
                    });
                    return options;
                }

                // Helper to populate select elements
                function populateSelects() {
                    const selects = ['expense-payer', 'task-assignee'];
                    selects.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = getParticipantOptions('');
                    });
                }

                // Settings UI
                function openSettings() {
                    document.getElementById('settings-modal').style.display = 'flex';
                    document.getElementById('api-url-input').value = apiUrl;
                    document.getElementById('gemini-key-input').value = geminiKey;
                }

                function closeSettings() {
                    document.getElementById('settings-modal').style.display = 'none';
                }

                function saveSettings() {
                    const url = document.getElementById('api-url-input').value.trim();
                    const key = document.getElementById('gemini-key-input').value.trim();

                    if (url) {
                        apiUrl = url;
                        localStorage.setItem(API_URL_KEY, apiUrl);
                    }
                    if (key) {
                        geminiKey = key;
                        localStorage.setItem(GEMINI_API_KEY_KEY, geminiKey);
                    }
                    closeSettings();
                    if (apiUrl) syncData();
                }

                function saveData() {
                    localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
                }

                // Core Sync Logic
                async function loadData() {
                    populateSelects();
                    const local = localStorage.getItem(APP_DATA_KEY);
                    if (local) {
                        try {
                            appData = JSON.parse(local);
                            if (!appData.meals || appData.meals.length === 0) appData.meals = JSON.parse(JSON.stringify(defaultData.meals));
                            if (!appData.courses) appData.courses = [];
                            if (!appData.budget) appData.budget = [];
                            if (!appData.tasks) appData.tasks = [];
                        } catch (e) {
                            console.error("Error parsing local data", e);
                            appData = JSON.parse(JSON.stringify(defaultData));
                        }
                    } else {
                        appData = JSON.parse(JSON.stringify(defaultData));
                    }
                    refreshUI();
                    if (apiUrl) {
                        await syncData();
                    }
                }

                async function syncData() {
                    if (!apiUrl) return;
                    const btn = document.querySelector('button[title="Synchroniser maintenant"]');
                    if (btn) {
                        btn.classList.add('rotating');
                        btn.innerHTML = "‚è≥";
                    }

                    try {
                        const response = await fetch(apiUrl);
                        const data = await response.json();

                        if (data && !data.error) {
                            appData = data;
                            if (!appData.meals || appData.meals.length === 0) appData.meals = JSON.parse(JSON.stringify(defaultData.meals));
                            if (!appData.courses) appData.courses = [];
                            if (!appData.budget) appData.budget = [];
                            if (!appData.tasks) appData.tasks = [];

                            localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
                            refreshUI();
                            if (btn) btn.innerHTML = "‚úÖ";
                        } else {
                            console.error("Invalid data received", data);
                            if (btn) {
                                btn.innerHTML = "‚ö†Ô∏è";
                                const statusEl = document.getElementById('sync-status');
                                if (statusEl) statusEl.innerText = "Erreur: " + (data.error || "Inconnue");
                            }
                        }
                    } catch (e) {
                        console.error("Sync error", e);
                        if (btn) btn.innerHTML = "‚ùå";

                        // Try to push local data if fetch failed
                        try {
                            const formData = new FormData();
                            formData.append('data', JSON.stringify(appData));
                            await fetch(apiUrl, {
                                method: 'POST',
                                body: formData
                            });
                            if (btn) btn.innerHTML = "‚úÖ";
                        } catch (e2) {
                            console.error("Save error", e2);
                            if (btn) btn.innerHTML = "‚ö†Ô∏è";
                        }
                    }
                    if (btn) setTimeout(() => btn.innerHTML = "üîÑ", 2000);
                }

                function refreshUI() {
                    renderMeals();
                    renderGroceryList();
                    renderBudget();
                    renderTasks();
                    updateCountdown();
                }

                // --- MEALS MODULE ---
                function renderMeals() {
                    const container = document.getElementById('meals-container');
                    if (!container) return;
                    container.innerHTML = '';

                    appData.meals.forEach((meal, index) => {
                        const mealDiv = document.createElement('div');
                        mealDiv.className = 'meal-block';
                        mealDiv.style.marginBottom = '2rem';
                        mealDiv.style.padding = '1rem';
                        mealDiv.style.backgroundColor = '#f9f9f9';
                        mealDiv.style.borderRadius = '8px';
                        mealDiv.style.borderLeft = '4px solid var(--christmas-red)';

                        const createRow = (type, label, val, by) => `
                    <div class="input-row" style="display:flex; gap:0.5rem; margin-bottom:0.5rem; align-items:center;">
                        <input type="text" placeholder="${label}" value="${val || ''}" 
                            onchange="updateMeal(${index}, '${type}', this.value)" style="flex:2; margin-bottom:0;">
                        <select onchange="updateMeal(${index}, '${type}_by', this.value)" style="flex:1; margin-bottom:0;">
                            ${getParticipantOptions(by)}
                        </select>
                    </div>
                `;

                        mealDiv.innerHTML = `
                    <h3 style="margin-top:0">${meal.title}</h3>
                    <div style="display:grid; gap:0.5rem;">
                        ${createRow('starter', 'Entr√©e', meal.starter, meal.starter_by)}
                        ${createRow('main', 'Plat Principal', meal.main, meal.main_by)}
                        ${createRow('dessert', 'Dessert', meal.dessert, meal.dessert_by)}
                    </div>
                `;
                        container.appendChild(mealDiv);
                    });
                }

                function updateMeal(index, field, newValue) {
                    const oldValue = appData.meals[index][field];
                    appData.meals[index][field] = newValue;

                    // Auto-add to grocery list if food item changed
                    if (!field.endsWith('_by')) {
                        if (oldValue) {
                            // Remove old item if it exists in grocery list (simple check)
                            const itemIndex = appData.courses.findIndex(c => c.name === oldValue);
                            if (itemIndex !== -1) {
                                if (newValue) appData.courses[itemIndex].name = newValue;
                                else appData.courses.splice(itemIndex, 1);
                            }
                        } else if (newValue) {
                            appData.courses.push({ name: newValue, category: 'Autre', done: false, assignee: '' });
                        }
                    }

                    if (newValue) {
                        const mealTitle = appData.meals[index].title;
                        const budgetDesc = `Budget ${mealTitle}`;
                        const budgetExists = appData.budget.some(b => b.desc === budgetDesc);
                        if (!budgetExists) {
                            appData.budget.push({ desc: budgetDesc, amount: 0, payer: '' });
                        }
                    }

                    saveData();
                    renderGroceryList();
                    renderBudget();
                }

                function renderGroceryList() {
                    const container = document.getElementById('grocery-list-container');
                    if (!container) return;
                    container.innerHTML = '';

                    const categories = { 'Frais': [], '√âpicerie': [], 'Boissons': [], 'Autre': [] };

                    appData.courses.forEach((item, index) => {
                        if (!categories[item.category]) categories['Autre'].push({ item, index });
                        else categories[item.category].push({ item, index });
                    });

                    for (const [cat, items] of Object.entries(categories)) {
                        if (items.length === 0) continue;

                        const catHeader = document.createElement('h4');
                        catHeader.style.color = 'var(--christmas-green)';
                        catHeader.style.borderBottom = '1px solid #eee';
                        catHeader.innerText = cat;
                        container.appendChild(catHeader);

                        const list = document.createElement('ul');
                        list.style.listStyle = 'none';
                        list.style.padding = 0;

                        items.forEach(({ item, index }) => {
                            const li = document.createElement('li');
                            li.style.display = 'flex';
                            li.style.alignItems = 'center';
                            li.style.padding = '0.5rem 0';
                            li.style.borderBottom = '1px dashed #eee';

                            li.innerHTML = `
                        <input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleGroceryItem(${index})" style="width:auto; margin:0 1rem 0 0;">
                        <span style="flex:1; text-decoration: ${item.done ? 'line-through' : 'none'}; color: ${item.done ? '#aaa' : 'inherit'}">${item.name}</span>
                        <select onchange="updateGroceryAssignee(${index}, this.value)" style="margin-left:auto; width:auto; padding:0.2rem; font-size:0.8rem;">
                            ${getParticipantOptions(item.assignee)}
                        </select>
                        <button onclick="deleteGroceryItem(${index})" style="background:none; border:none; cursor:pointer; color:#999; margin-left:0.5rem;">‚ùå</button>
                    `;
                            list.appendChild(li);
                        });
                        container.appendChild(list);
                    }
                }

                function addGroceryItem() {
                    const nameInput = document.getElementById('new-item-name');
                    const catInput = document.getElementById('new-item-category');
                    const name = nameInput.value.trim();
                    const category = catInput.value;

                    if (name) {
                        appData.courses.push({ name, category, done: false, assignee: '' });
                        nameInput.value = '';
                        saveData();
                        renderGroceryList();
                    }
                }

                function toggleGroceryItem(originalIndex) {
                    appData.courses[originalIndex].done = !appData.courses[originalIndex].done;
                    saveData();
                    renderGroceryList();
                }

                function updateGroceryAssignee(index, assignee) {
                    appData.courses[index].assignee = assignee;
                    saveData();
                }

                function deleteGroceryItem(index) {
                    if (confirm('Supprimer cet article ?')) {
                        appData.courses.splice(index, 1);
                        saveData();
                        renderGroceryList();
                    }
                }

                // --- BUDGET MODULE ---
                function renderBudget() {
                    const container = document.getElementById('budget-list-container');
                    if (!container) return;
                    container.innerHTML = '';

                    let total = 0;

                    appData.budget.forEach((expense, index) => {
                        total += parseFloat(expense.amount);
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid #eee';

                        tr.innerHTML = `
                    <td style="padding: 0.8rem 0.5rem;">${expense.desc}</td>
                    <td style="padding: 0.8rem 0.5rem;">${expense.payer || '<span style="color:#999; font-style:italic;">?</span>'}</td>
                    <td style="padding: 0.8rem 0.5rem; text-align: right; font-weight: bold;">${parseFloat(expense.amount).toFixed(2)} ‚Ç¨</td>
                    <td style="padding: 0.8rem 0.5rem; text-align: right;">
                        <button onclick="deleteExpense(${index})" style="background:none; border:none; cursor:pointer; color:#999;">‚ùå</button>
                    </td>
                `;
                        container.appendChild(tr);
                    });

                    document.getElementById('total-cost').innerText = total.toFixed(2) + ' ‚Ç¨';
                    document.getElementById('cost-per-adult').innerText = (total / 6).toFixed(2) + ' ‚Ç¨';
                }

                function addExpense() {
                    const descInput = document.getElementById('expense-desc');
                    const amountInput = document.getElementById('expense-amount');
                    const payerInput = document.getElementById('expense-payer');

                    const desc = descInput.value.trim();
                    const amount = parseFloat(amountInput.value);
                    const payer = payerInput.value;

                    if (!desc || isNaN(amount)) return;

                    appData.budget.push({ desc: desc, amount: amount, payer: payer });
                    descInput.value = '';
                    amountInput.value = '';
                    payerInput.value = '';
                    saveData();
                    renderBudget();
                }

                function deleteExpense(index) {
                    if (confirm('Supprimer cette d√©pense ?')) {
                        appData.budget.splice(index, 1);
                        saveData();
                        renderBudget();
                    }
                }

                // --- TASKS MODULE ---
                function renderTasks() {
                    const container = document.getElementById('tasks-list-container');
                    if (!container) return;
                    container.innerHTML = '';

                    appData.tasks.forEach((task, index) => {
                        const li = document.createElement('li');
                        li.style.display = 'flex';
                        li.style.alignItems = 'center';
                        li.style.padding = '0.5rem';
                        li.style.borderBottom = '1px solid #eee';
                        li.style.backgroundColor = task.done ? '#f0f0f0' : 'white';

                        li.innerHTML = `
                    <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${index})" style="width:auto; margin-right:1rem;">
                    <div style="flex:1; text-decoration: ${task.done ? 'line-through' : 'none'}; color: ${task.done ? '#aaa' : 'inherit'}">
                        <strong>${task.desc}</strong>
                        <div style="font-size:0.8rem; color:#666;">Assign√© √† : ${task.assignee || '?'}</div>
                    </div>
                    <button onclick="deleteTask(${index})" style="background:none; border:none; cursor:pointer; color:#999;">‚ùå</button>
                `;
                        container.appendChild(li);
                    });
                }

                function addTask() {
                    const descInput = document.getElementById('task-desc');
                    const assigneeInput = document.getElementById('task-assignee');
                    const desc = descInput.value.trim();
                    const assignee = assigneeInput.value;

                    if (desc) {
                        appData.tasks.push({ desc, assignee, done: false });
                        descInput.value = '';
                        assigneeInput.value = '';
                        saveData();
                        renderTasks();
                    }
                }

                function toggleTask(index) {
                    appData.tasks[index].done = !appData.tasks[index].done;
                    saveData();
                    renderTasks();
                }

                function deleteTask(index) {
                    if (confirm('Supprimer cette t√¢che ?')) {
                        appData.tasks.splice(index, 1);
                        saveData();
                        renderTasks();
                    }
                }

                // Initialize
                loadData();

            </script>
</body>

</html>